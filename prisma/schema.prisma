generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql" // 或 sqlite (開發用)
}

enum Role {
  USER
  ADMIN
}

model User {
  id              Int              @id @default(autoincrement())
  username        String           @unique
  password        String           // Hashed
  displayName     String
  avatar          String           @default("avatar_00.webp") // 新增：頭像欄位
  cash            Float            @default(50.0)
  stocks          Int              @default(0)
  debt            Float            @default(0.0) 
  dailyBorrowed   Int              @default(0)      // 【新增】每日借款追蹤 (每日重置)
  role            Role             @default(USER)
  firstSignIn     Boolean          @default(true)
  isEmployee      Boolean          @default(false)
  contractOrders  ContractOrder[]  // 關聯：合約訂單

  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
}


model GameStatus {
  id              Int       @id @default(1) // 全域狀態，永遠只有 id: 1 這一筆
  isGameStarted   Boolean   @default(false)
  gameStartTime   DateTime? // 核心：遊戲開始的絕對時間，用於計算精確進度
  pausedAt        DateTime? // 【新增】暫停時間戳記
  
  // 遊戲配置參數 (動態載入)
  currentDay      Int       @default(0)
  timeRatio       Int       @default(60)      // 現實秒數 = 遊戲一天 (預設 60 秒)
  totalDays       Int       @default(120)     // 遊戲總天數 (預設 120 天)
  initialPrice    Float     @default(50.0)    // 股票起始價格
  initialCash     Float     @default(50.0)    // 使用者起始現金
  maxLeverage     Float     @default(10.0)    // 合約交易最大槓桿倍數 (改為 10.0)
  
  // 【新增】地下錢莊參數
  dailyInterestRate Float   @default(0.0001)  // 日利率 (預設 0.01%)
  maxLoanAmount     Int     @default(10000)   // 最高借款金額 (改為 10000)
}

model Event {
  id        Int      @id @default(autoincrement())
  day       Int      
  title     String
  news      String?  @db.Text 
  trend     Trend    // (使用 Enum)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ScriptDay {
  id                Int     @id @default(autoincrement())
  day               Int     // 1, 2, 3... 120
  price             Float   
  title             String? // 當天發布的新聞標題
  news              String? @db.Text 
  effectiveTrend    String  // 當天 "實際生效" 的趨勢
  publishTimeOffset Int?    // 新聞發布的秒數偏移量 (0~59)，由演算法隨機產生
  isNewsBroadcasted Boolean @default(false) // 【新增】是否已廣播過新聞
}

model ContractOrder {
  id           Int          @id @default(autoincrement())
  userId       Int
  user         User         @relation(fields: [userId], references: [id])
  
  day          Int          // 下單時的遊戲天數 (Day X 下單，Day X+1 結算)
  type         ContractType // LONG / SHORT
  leverage     Float        // 1.0 ~ 10.0
  quantity     Int          // 張數 (例如 1)
  margin       Float        // 保證金 (下單時扣除的現金，例如 $20)
  entryPrice   Float        // 進場價格 (用於計算損益，CRITICAL)
  
  isSettled    Boolean      @default(false) // 是否已結算
  isCancelled  Boolean      @default(false) // 是否已撤單
  createdAt    DateTime     @default(now())
}

// 紅包遊戲獎項設定
model RedEnvelopeItem {
  id           Int     @id @default(autoincrement())
  name         String
  type         String   @default("PHYSICAL") // "PHYSICAL" | "CASH"
  prizeValue   Int      @default(0)           // 若 type="CASH"，代表發放的金額
  amount       Int
  displayOrder Int     @default(0) // 價值排序（數字越小越優先）
  isActive     Boolean @default(true)
}

// 機智問答題庫
model QuizQuestion {
  id            Int      @id @default(autoincrement())
  question      String
  optionA       String
  optionB       String
  optionC       String
  optionD       String
  correctAnswer String   // "A", "B", "C", "D"
  rewards       Json     // { first: 20, second: 15, third: 10, others: 5 }
  duration      Int      @default(10)
  createdAt     DateTime @default(now())
}

// 少數決題庫
model MinorityQuestion {
  id        Int      @id @default(autoincrement())
  question  String
  optionA   String
  optionB   String
  optionC   String
  optionD   String
  duration  Int      @default(10) // 下注時間（秒）
  createdAt DateTime @default(now())
}

// 小遊戲運行時狀態（僅存一筆，用於重啟恢復）
model MiniGameRuntime {
  key       String   @id // 固定為 "CURRENT_GAME"
  gameType  String   // "NONE", "RED_ENVELOPE", "QUIZ", "MINORITY"
  phase     String   // "IDLE", "SHUFFLE", "GAMING", "RESULT"...
  roundId   String   @default(uuid()) // 區分回合
  startTime BigInt?
  endTime   BigInt?
  payload   Json
  updatedAt DateTime @updatedAt
}


// (Enum 保持不變)
enum Trend {
  CHAO_LI_DUO
  LI_DUO
  PAN_ZHENG
  LI_KONG
  CHAO_LI_KONG
  BU_YING_XIANG
}

enum ContractType { 
  LONG
  SHORT
}